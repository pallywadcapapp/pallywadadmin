@{
    ViewBag.Title = "Loan Request";
}

<link href="css/index_style.css" rel="stylesheet">
<style>
    .hide {
        display: none;
    }

    .select2-selection {
        height: 34px !important;
        font-size: 13px;
        font-family: 'Open Sans', sans-serif;
        border-radius: 0 !important;
        border: solid 1px #c4c4c4 !important;
        padding-left: 4px;
    }

    .select2-selection--multiple {
        height: 154px !important;
        width: 366px !important;
    }

    .select2-selection__choice {
        height: 40px;
        line-height: 40px;
        padding-right: 16px !important;
        padding-left: 16px !important;
        background-color: #CAF1FF !important;
        color: #333 !important;
        border: none !important;
        border-radius: 3px !important;
    }

    .select2-selection__choice__remove {
        float: right;
        margin-right: 0;
        margin-left: 2px;
    }

    .select2-search--inline .select2-search__field {
        line-height: 40px;
        color: #333;
        width: 100% !important;
    }

    .select2-container:hover,
    .select2-container:focus,
    .select2-container:active,
    .select2-selection:hover,
    .select2-selection:focus,
    .select2-selection:active {
        outline-color: transparent;
        outline-style: none;
    }

    .select2-results__options li {
        display: block;
    }

    .select2-selection__rendered {
        transform: translateY(2px);
    }

    .select2-selection__arrow {
        display: none;
    }

    .select2-results__option--highlighted {
        background-color: #CAF1FF !important;
        color: #333 !important;
    }

    .select2-dropdown {
        border-radius: 0 !important;
        box-shadow: 0px 3px 6px 0 rgba(0, 0, 0, 0.15) !important;
        border: none !important;
        margin-top: 4px !important;
        width: 366px !important;
    }

    .select2-results__option {
        font-family: 'Open Sans', sans-serif;
        font-size: 13px;
        line-height: 24px !important;
        vertical-align: middle !important;
        padding-left: 8px !important;
    }

        .select2-results__option[aria-selected="true"] {
            background-color: #eee !important;
        }

    .select2-search__field {
        font-family: 'Open Sans', sans-serif;
        color: #333;
        font-size: 13px;
        padding-left: 8px !important;
        border-color: #c4c4c4 !important;
    }

    .select2-selection__placeholder {
        color: #c4c4c4 !important;
    }

    .pull-right {
        margin-right: 10px;
    }

    p {
        margin-left: 5%;
    }

    .gg {
        margin-left: 5%;
    }
</style>
<div class="container-fluid">
    <!-- Breadcrumbs-->
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="#">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">Loan Request</li>
    </ol>
    <!-- Example DataTables Card-->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fa fa-table"></i>Loan Request
        </div>
        <div class="card-body">
            <form id="lrForm">
                <div>
                    <h3>Select Member</h3>
                    <section>
                        <div class="row">
                            <div class="col-sm-12 input-group">
                                <span class="input-group-addon">Member</span>
                                <select class="required form-control mb-2 mr-sm-2" id="members"></select>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Member ID</span>
                                <span class="required form-control mb-2 mr-sm-2" name="userName"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Last Name</span>
                                <span class="required form-control mb-2 mr-sm-2"name="lastname"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">First Name</span>
                                <span class="required form-control mb-2 mr-sm-2" name="firstname"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Sav Account No</span>
                                <span class="required form-control mb-2 mr-sm-2" name="accountno"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Phone No</span>
                                <span class="required form-control mb-2 mr-sm-2" name="phoneNumber"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Employment Date</span>
                                <span class="required form-control mb-2 mr-sm-2" name="employdate"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Retirement Date</span>
                                <span class="required form-control mb-2 mr-sm-2" name="retiredate"></span>
                            </div>
                            <div class="col-sm-6 input-group">
                                <span class="input-group-addon">Email Address</span>
                                <span class="required form-control mb-2 mr-sm-2" name="email"></span>
                            </div>
                            <div class="col-sm-12 input-group">
                                <span class="input-group-addon">Address</span>
                                <span class="required form-control mb-2 mr-sm-2" name="address"></span>
                            </div>
                            
                        </div>
                    </section>
                    <h3>Loan Details</h3>
                    <section>
                        <div class="row">
                            <div class="form-group modsp col-sm-3">
                                <span>Savings Balance </span><input type="text" disabled class="form-control"
                                                                    id="sbalance" name="savingBalance" />
                            </div>
                            <div class="form-group modsp col-sm-3">
                                <span>Long Term Loan Balance </span><input type="text" disabled class="form-control" id="lbalance"
                                                                 name="loanBalance" />
                            </div>
                            <div class="form-group modsp col-sm-3">
                                <span>Short Term Loan Balance </span><input type="text" disabled class="form-control" id="shortloanBalance"
                                                                name="shortloanBalance" />
                            </div>
                            <div class="form-group modsp col-sm-3">
                                <span>Net Balance </span><input type="text" disabled class="form-control" id="nbalance"
                                                                name="netBalance" />
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>Loan Amount </span><input type="number" placeholder="Loan Amount"
                                                                class="form-control" id="amount" />
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>Loan Types</span><select class="form-control" id="loanTypes"></select>
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>Bank Name </span><input type="text" placeholder="Bank Name" class="form-control"
                                                              id="bankname" />
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>Account Number</span><input type="text" placeholder="Bank Account Number"
                                                                  class="form-control" id="bankaccountno" />
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>BVN </span><input type="text" placeholder="BVN" class="form-control" id="bvn" />
                            </div>
                            <div class="form-group modsp col-sm-6">
                                <span>Other Coorperative Loan </span><input type="text" placeholder="Other Coop Loan"
                                                                            class="form-control" id="othercoorp" />
                            </div>
                            <div class="form-group modsp col-sm-12">
                                <span>Guarantors</span><select class="form-control" id="guarantors"
                                                               multiple="multiple"></select>
                            </div>
                        </div>
                    </section>
                </div>
            </form>
            
            
        </div>
        <div class="card-footer small text-muted">Updated Today at <span id="todayT"></span></div>


    </div>
</div>

@section Scripts{
    <script src="~/Scripts/config.js" type="text/javascript"></script>
    <script>
        var lb = 0;
        var  savBal = 0; var loanBal = 0; var shortloanBal = 0;
        var selectedOptions = [];
        var $guarantors = $('#guarantors');
        var form = $("#lrForm");
        form.children("div").steps({
            headerTag: "h3",
            bodyTag: "section",
            transitionEffect: "slideLeft",
            onStepChanging: function (event, currentIndex, newIndex) {
                //form.validate().settings.ignore = ":disabled,:hidden";

                // Always allow going backward even if the current step contains invalid fields!
                if (currentIndex > newIndex) {
                    return true;
                }
                //var form = $(this);

                // Clean up if user went backward before
                if (currentIndex < newIndex) {
                    // To remove error styles
                    $(".body:eq(" + newIndex + ") label.error", form).remove();
                    $(".body:eq(" + newIndex + ") .error", form).removeClass("error");
                }

                /*var nextStep = '#example-form #example-form-p-' + newIndex;
                var heightNextStep = $(nextStep).css('minHeight');
                            $(nextStep).parent().animate({
                        height: heightNextStep
                }, 200);*/
                $('.current').css('minHeight');
                return form.valid();
            },
            onFinishing: function (event, currentIndex) {
                //form.validate().settings.ignore = ":disabled";
                //
                saveLoanRequest();
                return form.valid();
            },
            onFinished: function (event, currentIndex) {
                //alert("Submitted!");
            }
        });

        function getMember(memberId){
            var usavingsUrl = appConfig.adminURL + 'api/user/userbyid?email=' + memberId;
            $.get(usavingsUrl, function (_data) {
                try {
                               
                    var mydata = _data.member
                    for (var p in mydata) {
                        console.log(mydata[p]);
                        $('[name="'+ p +'"]').html(mydata[p]);
                    }
                    for (var _key in _data) {
                        if (_key == 'memAcc') {
                            var data = _data[_key];
                            if (data.length == 0) {
                                $('[name="savingBalance"]').val(currformatter.format(savBal));
                                $('[name="loanBalance"]').val(currformatter.format(loanBal));
                                                $('[name="shortloanBalance"]').val(currformatter.format(shortloanBal));
                            } else {
                                for (var key in data) {
                                    var acc = data[key];
                                    for (var v in acc) {
                                        if (v == 'acctype') {
                                            if (acc[v] == 'loans' || acc[v] == 'Loans') {
                                                loanBal = data[key].loanBalance;
                                                $('[name="' + acc[v] + '"]').html(currformatter.format(data[key].loanBalance));
                                                $('[name="loanBalance"]').val(currformatter.format(data[key].loanBalance));
                                                if (parseFloat(loanBal) < 1) {
                                                    $('#saveLoanReq').prop("disabled", false);
                                                } else {
                                                    $('#saveLoanReq').prop("disabled", true);
                                                }
                                            } else if (acc[v] == 'Short loans' || acc[v] == 'Short Loans') {
                                                shortloanBal = data[key].shortloanBal;
                                                $('[name="' + acc[v] + '"]').html(currformatter.format(shortloanBal));
                                                $('[name="shortloanBalance"]').val(currformatter.format(shortloanBal));
                                                if (parseFloat(shortloanBal) < 1) {
                                                    $('#saveLoanReq').prop("disabled", false);
                                                } else {
                                                    $('#saveLoanReq').prop("disabled", true);
                                                }
                                            } else {
                                                $('[name="' + acc[v] + '"]').html(currformatter.format(data[key].savBalance));
                                                $('[name="savingBalance"]').val(currformatter.format(data[key].savBalance));
                                                savBal = data[key].savBalance;
                                            }
                                        }
                                    }

                                    if (key == 'fullname') {
                                        localStorage.setItem('fullname', data[key]);
                                    }
                                }
                            }
                        }
                    }
                    netBal = parseFloat(savBal) - parseFloat(loanBal);
                    $('[name="netBalance"]').val(currformatter.format(netBal));
                } catch (e) {
                    console.log(e);
                }
            }).fail(function (xhr, message, error) {
                toastr.error('error ' + xhr.responseText + 'for getting savings balance ');

            });
        }

        $('#loanTypes').on('change',function(e){
                    var value = $(this).find('option:selected').text(); 
                    console.log(value);
                    if(value.indexOf('Short Term') !== -1){
                        lb = shortloanBal;
                    }else{
                        lb = loanBal;
                    }
                });

        function loadDefault() {
            var $members = $('#members');
            var $guarantors = $('#guarantors');
            var $loanTypes = $('#loanTypes');

            $.get(appConfig.adminURL + 'api/user/AllUsers', function (data) {
                $members.empty();
                $members.append('<option value="select">Select Member</option>');
                for (var counter = 0; counter <= data.length - 1; counter++) {
                    $option = $('<option value="' + data[counter].userName + '">' + data[counter].userName + ' - ' + data[counter].lastname +  ' ' + data[counter].firstname + '</option>');
                    $members.append($option);
                }
                //$members.select2({ width: '100%' });
                $members.select2({
                    placeholder: "Select Members",
                    width: 'element'
                })
                .on('change', function (e) {
                        if ($(this).val() && $(this).val().length) {
                            console.log($(this).val())
                            getMember($(this).val());
                        $(this).next('.select2-container')
                            .find('li.select2-search--inline input.select2-search__field').attr('placeholder', 'Select Members');
                    }
                });
            }).fail(function (e) {
                toastr.error('unable to get members list');
            });

            $.get(appConfig.apiURL + 'api/member/LoanTypes', function (data) {
                $loanTypes.empty();
                for (var counter = 0; counter <= data.length - 1; counter++) {
                    $option = $('<option value="' + data[counter].loancode + '">' + data[counter].category + ' ' + data[counter].loandesc + '</option>');

                    $loanTypes.append($option);
                }
                $loanTypes.select2({
                    placeholder: "Select Loan Types",
                    width: 'element'
                }).on('change', function (e) {
                    if ($(this).val() && $(this).val().length) {
                        $(this).next('.select2-container')
                            .find('li.select2-search--inline input.select2-search__field').attr('placeholder', 'Select Loan Types');
                    }
                });
            }).fail(function (e) {
                toastr.error('unable to get loan types list');
            });
            $.get(appConfig.apiURL + 'api/member/guarantors', function (data) {
                $guarantors.empty();
                for (var counter = 0; counter <= data.length - 1; counter++) {
                    $option = $('<option value="' + data[counter].guarantorId + '">' + data[counter].guarantorId + ' - ' + data[counter].guarantorName + '</option>');

                    $guarantors.append($option);
                }
                $guarantors.select2({
                    placeholder: "Select Guarantors",
                    width: 'element'
                }).on('change', function (e) {
                    if ($(this).val() && $(this).val().length) {
                        $(this).next('.select2-container')
                            .find('li.select2-search--inline input.select2-search__field').attr('placeholder', 'Select Guarantors');
                    }
                });
            }).fail(function (e) {
                toastr.error('unable to get guarantors list');
            });
        }

        function saveLoanRequest() {
            $('#lrForm').pleaseWait();

            var guarantors = $guarantors.val();

            var guarantorId1 = guarantors[0];
            var guarantorId2 = guarantors[1];
            var guarantorId3 = guarantors[2];

            var bankaccountno = $('#bankaccountno').val();
            var amount = $('#amount').val();
            var bvn = $('#bvn').val();
            var bankname = $('#bankname').val();
            var loanTypes = $('#loanTypes').val();
            var memberId = $('#members').val();
            var LoanRequest = {
                amount: amount,
                bankaccountno: bankaccountno,
                bvn: bvn,
                bankname: bankname,
                savBal: savBal,
                loanBal: lb,
                loancode: loanTypes,
                netBal: netBal,
                guarantorId1: guarantorId1,
                guarantorId2: guarantorId2,
                guarantorId3: guarantorId3,
                processState: 'pending',
                status: 'Pending',
                loanId: 'rrr',
                TenantId: 'rrr',
                approvedBy: 'rrr',
                memberId: memberId,
                postedby: ''
            }

            console.log(LoanRequest);
            var url = appConfig.apiURL + "api/admin/LoanRequest";
            $.ajax({
                type: 'POST',
                url: url,
                data: JSON.stringify(LoanRequest),
                contentType: "application/json",
            }).done(function (data) {
                $('#lrForm').pleaseWait('stop');
                $('#lrForm').modal('hide');
                toastr.success('Loan Request  submitted successfully');
                window.location.href = '../admin/loanrequest';
            }).fail(function (request, message, error) {
                $('#lrForm').pleaseWait('stop');
                toastr.error('error ' + error + 'for saving Loan Request ');
            });

        }

        
        $(function () {
            loadDefault();

                
        })
    </script>


}